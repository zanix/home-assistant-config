---
# OctoPrint is a web interface for your 3D printer.
#
# https://github.com/OctoPrint/OctoPrint-MQTT
# https://github.com/cmroche/OctoPrint-HomeAssistant
#
sensor:
  - platform: mqtt
    name: "OctoPrint Layer Progress"
    state_topic: "octoprint/event/DisplayLayerProgress_layerChanged"
    json_attributes_topic: "octoprint/event/DisplayLayerProgress_layerChanged"
    icon: mdi:stack-overflow
    value_template: '{{ value_json.currentLayer }} / {{ value_json.totalLayer }}'

  - platform: template
    sensors:
      octoprint_bed_temperature_c:
        friendly_name: OctoPrint Bed Temperature
        availability_template: "{{ states.sensor.octoprint_bed_temperature.state and states('sensor.octoprint_bed_temperature') != 'None' }}"
        unit_of_measurement: 'C'
        device_class: temperature
        icon_template: mdi:radiator
        value_template: '{{ (((states("sensor.octoprint_bed_temperature") | float) - 32) * 5/9) | round(2) }}'

      octoprint_soc_temperature_c:
        friendly_name: OctoPrint SoC Temperature
        availability_template: "{{ states.sensor.octoprint_soc_temperature.state and states('sensor.octoprint_soc_temperature') != 'None' }}"
        unit_of_measurement: 'C'
        device_class: temperature
        icon_template: mdi:radiator
        value_template: '{{ (((states("sensor.octoprint_soc_temperature") | float) - 32) * 5/9) | round(2) }}'

      octoprint_tool_0_temperature_c:
        friendly_name: OctoPrint Print Time
        availability_template: "{{ states.sensor.octoprint_tool_0_temperature.state and states('sensor.octoprint_tool_0_temperature') != 'None' }}"
        unit_of_measurement: 'C'
        device_class: temperature
        icon_template: mdi:radiator
        value_template: '{{ (((states("sensor.octoprint_tool_0_temperature") | float) - 32) * 5/9) | round(2) }}'

      octoprint_bed_target_c:
        friendly_name: OctoPrint Bed Target
        availability_template: "{{ states.sensor.octoprint_bed_target.state and states('sensor.octoprint_bed_target') != 'None' }}"
        unit_of_measurement: 'C'
        device_class: temperature
        icon_template: mdi:radiator
        value_template: '{{ (((states("sensor.octoprint_bed_target") | float) - 32) * 5/9) | round(2) }}'

      octoprint_tool_0_target_c:
        friendly_name: OctoPrint Tool 0 Target
        availability_template: "{{ states.sensor.octoprint_tool_0_target.state and states('sensor.octoprint_tool_0_target') != 'None' }}"
        unit_of_measurement: 'C'
        device_class: temperature
        icon_template: mdi:radiator
        value_template: '{{ (((states("sensor.octoprint_tool_0_target") | float) - 32) * 5/9) | round(2) }}'

      octoprint_print_time_format:
        friendly_name: OctoPrint Print Time
        availability_template: "{{ states.sensor.octoprint_print_time.state and states('sensor.octoprint_print_time') != 'None' }}"
        value_template: >-
          {%- if states.sensor.octoprint_print_time.state and states('sensor.octoprint_print_time') != 'None' -%}
            {%- set time = states('sensor.octoprint_print_time').split(':') -%}
            {%- set seconds = time[2]|int -%}
            {%- set minutes = time[1]|int -%}
            {%- set hours = time[0]|int -%}
            {%- set days = 0 -%}
            {%- if time|length > 3 -%}
              {% set seconds = time[3]|int %}
              {% set minutes = time[2]|int %}
              {% set hours = time[1]|int %}
              {% set days = time[0]|int %}
            {%- endif -%}
            {%- if days > 0 -%}
              {{ days }}d
            {%- endif -%}
            {%- if hours > 0 -%}
              {%- if days > 0 %}, {% endif -%}
              {{ hours }}h
            {%- endif -%}
            {%- if minutes > 0 -%}
              {%- if hours > 0 or days > 0 %}, {% endif -%}
              {{ minutes }}m
            {%- endif -%}
            {%- if seconds > 0 -%}
              {%- if minutes > 0 or hours > 0 or days > 0 %}, {% endif -%}
              {{ seconds }}s
            {%- endif %}
          {%- else -%}
            0:0:0
          {%- endif -%}
        icon_template: mdi:clock-start

      octoprint_print_time_left_format:
        friendly_name: OctoPrint Print Time Left
        availability_template: "{{ states.sensor.octoprint_print_time_left.state and states('sensor.octoprint_print_time_left') != 'None' }}"
        value_template: >-
          {%- if states.sensor.octoprint_print_time_left.state and states('sensor.octoprint_print_time_left') != 'None' -%}
            {%- set time = states('sensor.octoprint_print_time_left').split(':') -%}
            {%- set seconds = time[2]|int -%}
            {%- set minutes = time[1]|int -%}
            {%- set hours = time[0]|int -%}
            {%- set days = 0 -%}
            {%- if time|length > 3 -%}
              {% set seconds = time[3]|int %}
              {% set minutes = time[2]|int %}
              {% set hours = time[1]|int %}
              {% set days = time[0]|int %}
            {%- endif -%}
            {%- if days > 0 -%}
              {{ days }}d
            {%- endif -%}
            {%- if hours > 0 -%}
              {%- if days > 0 %}, {% endif -%}
              {{ hours }}h
            {%- endif -%}
            {%- if minutes > 0 -%}
              {%- if hours > 0 or days > 0 %}, {% endif -%}
              {{ minutes }}m
            {%- endif -%}
            {%- if seconds > 0 -%}
              {%- if minutes > 0 or hours > 0 or days > 0 %}, {% endif -%}
              {{ seconds }}s
            {%- endif %}
          {%- else -%}
            0:0:0
          {%- endif -%}
        icon_template: mdi:clock-end

      octoprint_print_file_size:
        friendly_name: File Size
        availability_template: "{{ states.sensor.octoprint_print_estimated_time.state and states('sensor.octoprint_print_estimated_time') != 'None' }}"
        value_template: >-
          {%- if states.sensor.octoprint_print_estimated_time.state and states('sensor.octoprint_print_estimated_time') != 'None' -%}
            {%- set file = state_attr("sensor.octoprint_print_estimated_time", "file") -%}
            {{ (file["size"] / 1049000)|round(2) }}
          {%- else -%}
            0
          {%- endif -%}
        icon_template: mdi:file-code-outline
        unit_of_measurement: 'MB'

      octoprint_filament_length:
        friendly_name: Filament Length
        availability_template: "{{ states.sensor.octoprint_print_estimated_time.state and states('sensor.octoprint_print_estimated_time') != 'None' }}"
        value_template: >-
          {%- if states.sensor.octoprint_print_estimated_time.state and states('sensor.octoprint_print_estimated_time') != 'None' -%}
            {%- set filament = state_attr('sensor.octoprint_print_estimated_time', 'filament') -%}
            {{ (filament["tool0"]["length"] / 1000)|round(2) }}
          {%- else -%}
            0
          {%- endif -%}
        icon_template: mdi:ruler
        unit_of_measurement: 'm'

      octoprint_filament_cost:
        friendly_name: "Cost"
        availability_template: "{{ states.sensor.octoprint_print_estimated_time.state and states('sensor.octoprint_print_estimated_time') != 'None' }}"
        value_template: >-
          {%- if states.sensor.octoprint_print_estimated_time.state and states('sensor.octoprint_print_estimated_time') != 'None' -%}
            {%- set filament = state_attr('sensor.octoprint_print_estimated_time', 'filament') -%}
            {{ ((filament["tool0"]["length"] / 1000)|multiply(0.072))|round(2) }}
          {%- else -%}
            0
          {%- endif -%}
        icon_template: mdi:currency-usd
        unit_of_measurement: '$'

automation:
  - id: notify_ender_3_pro
    alias: "[Notify] Ender 3 Pro"
    trigger:
      - platform: state
        entity_id: sensor.octoprint_print_status
        from: Printing
        to: Operational
    action:
      - service: script.notify_mobile
        data:
          who: "josh"
          title: "3D Print Finished"
          message: "{{ states('sensor.octoprint_print_file') }} finished printing in {{ states('sensor.octoprint_print_time_format') }}"
          icon: "/local/icons/printer-3d.png"
          group: "3d-printer"

history:
  exclude:
    entities:
      - sensor.octoprint_print_file_size
      - sensor.octoprint_filament_length
      - sensor.octoprint_filament_cost
      - sensor.octoprint_print_time_format
      - sensor.octoprint_print_time_left_format
      - sensor.octoprint_layer_progress

recorder:
  exclude:
    entities:
      - sensor.octoprint_print_file_size
      - sensor.octoprint_filament_length
      - sensor.octoprint_filament_cost
      - sensor.octoprint_print_time_format
      - sensor.octoprint_print_time_left_format
      - sensor.octoprint_layer_progress

influxdb:
  exclude:
    entities:
      - sensor.octoprint_print_file_size
      - sensor.octoprint_filament_length
      - sensor.octoprint_filament_cost
      - sensor.octoprint_print_time_format
      - sensor.octoprint_print_time_left_format
      - sensor.octoprint_layer_progress
