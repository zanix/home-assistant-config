---
id: subaru_failed_start
alias: '[Notify] Subaru Failed Notification'
description: 'Sends a notification when the Subaru fails to start'

trigger:
  platform: event
  event_type: call_service
  event_data:
    domain: persistent_notification
    service: create

variables:
  message: 'The Subaru did not start, please try again'

condition:
  - condition: template
    value_template: >-
      {%- if trigger.event.data.service_data.title == 'Subaru' and 'failed' in trigger.event.data.service_data.message -%}
        true
      {%- endif -%}

action:
  - parallel:
      - service: script.notify_mobile
        data:
          who: 'parents'
          title: 'Subaru Remote Start'
          message: '{{ message }}'
          icon: '/local/icons/car-estate.png'
          group: 'Subaru'
          tag: 'subaru'
          url: 'lovelace/subaru'
          actions:
            - action: 'remote_start_again'
              title: 'Retry'

      - service: script.notify_join
        data:
          who: 'shield_all'
          title: 'Subaru Remote Start'
          message: '{{ message }}'
          icon: 'local/icons/car-estate.png'
          group: 'Subaru'
          tag: 'subaru'

      - service: script.notify_speech
        data:
          media_player: media_player.living_room_speaker
          message: '{{ message }}'
