---
id: notify_garage_door_left_open
alias: '[Notify] Garage Door Left Open'
description: 'Sends notification if the garage door is left open'

trigger:
  platform: state
  entity_id:
    - cover.garage_door
  from: 'closed'
  to: 'open'
  for:
    minutes: 30

condition:
  - condition: state
    entity_id: binary_sensor.garage_occupancy
    state: 'off'
  - condition: state
    entity_id: input_boolean.ignore_alert_garage_door
    state: 'off'

action:
  - repeat:
      until:
        - or:
            - condition: state
              entity_id: input_boolean.ignore_alert_garage_door
              state: 'on'
            - condition: template
              value_template: '{{ is_state(trigger.to_state.entity_id, "closed") }}'
      sequence:
        - variables:
            name: '{{ trigger.to_state.name }}'
            message: >-
              The {{ name }} has been open for {{ trigger.to_state.last_changed|relative_time }}.

        - parallel:
            - service: script.notify_mobile
              data:
                who: 'parents'
                title: '{{ name }}'
                message: '{{ message }}'
                icon: '/local/icons/garage-open.png'
                group: 'Security'
                tag: 'garage-door'
                url: 'lovelace/security'
                actions:
                  - action: 'ignore_garage_door_alerts'
                    title: 'Ignore Alerts'
                  - action: 'close_garage_door'
                    title: 'Close'

            - service: script.notify_join
              data:
                who: 'shield_all'
                title: '{{ name }}'
                message: '{{ message }}'
                icon: 'local/icons/garage-open.png'
                group: 'Security'
                tag: 'garage-door'

            - service: script.notify_speech
              data:
                media_player: group.google_speakers
                message: '{{ message }}'

        - wait_template: '{{ is_state(trigger.to_state.entity_id, "closed") }}'
          timeout:
            minutes: 30
