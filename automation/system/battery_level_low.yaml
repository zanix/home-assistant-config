---
id: system_battery_level_low
alias: '[System] Battery Level Low'
description: 'Sends a notification when a device battery level is low'

trigger:
  - platform: state
    entity_id: sensor.low_battery_devices

variables:
  sensors: >-
    {% set ignore_entities = [
      "sensor.galaxy_s21_battery_level",
      "sensor.pixel_6_battery_level",
      "sensor.ipad_josh_battery_level"
    ] %}
    {% set threshold = 30 %}
    {% set result = namespace(sensors=[]) %}
    {% set devices = states.sensor
      | reject('in', ['unknown', 'unavailable', 'undefined'])
      | rejectattr('entity_id', 'in', ignore_entities)
      | rejectattr('attributes.device_class', 'undefined')
      | selectattr('attributes.device_class', 'eq', 'battery')
      | list
    %}
    {% for device in devices %}
      {% if device.state | int(-1) <= threshold | int %}
        {% set name = device.name|replace(" [Battery Level]", "")|replace(" Battery Level", "")|replace(": Battery level", "") %}
        {% set result.sensors = result.sensors + [name ~ ' (' ~ device.state ~ '%)'] %}
      {% endif %}
    {% endfor %}
    {{ result.sensors|join(', ') }}

condition:
  - condition: template
    value_template: '{{ (trigger.to_state.state|int(default=0)) > 0 }}'
  - condition: template
    value_template: '{{ (trigger.to_state.state|int(default=0)) != (trigger.from_state.state|int(default=0)) }}'
  - condition: template
    value_template: '{{ sensors != "" }}'

action:
  - parallel:
      - service: script.notify_web
        data:
          title: 'Low Battery Levels'
          message: '{{ sensors }}'
          id: 'low-battery-alert'

      - service: script.notify_mobile
        data:
          who: 'josh'
          title: 'Low Battery Levels'
          message: '{{ sensors }}'
          icon: '/local/icons/battery-alert.png'
          group: 'System'
          tag: 'low-battery-alert'
          url: 'dashboard-system/overview'
