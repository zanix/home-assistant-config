---
id: notify_door_left_open
alias: '[Notify] Door Left Open'
description: 'Sends notification when a door is left open'
mode: parallel

trigger:
  platform: state
  entity_id: !include ../../templates/doors.yaml
  from: 'off'
  to: 'on'
  for:
    minutes: 5

condition:
  - condition: state
    entity_id: input_boolean.ignore_alert_doors
    state: 'off'

action:
  - repeat:
      until:
        - or:
            - condition: state
              entity_id: input_boolean.ignore_alert_doors
              state: 'on'
            - condition: template
              value_template: '{{ is_state(trigger.to_state.entity_id, "off") }}'
      sequence:
        - variables:
            name: '{{ trigger.to_state.name }}'
            message: >-
              The {{ name }} has been open for {{ trigger.to_state.last_changed|relative_time }}.

        - parallel:
            - service: script.notify_mobile
              data:
                who: 'parents'
                title: '{{ name }}'
                message: '{{ message }}'
                icon: '/local/icons/door-open.png'
                group: 'Security'
                tag: 'door-{{ trigger.to_state.object_id }}'
                url: 'lovelace/security'
                actions:
                  - action: 'ignore_door_alerts'
                    title: 'Ignore Alerts'

            - service: script.notify_join
              data:
                who: 'shield_all'
                title: '{{ name }}'
                message: '{{ message }}'
                icon: 'local/icons/door-open.png'
                group: 'Security'
                tag: 'door-{{ trigger.to_state.object_id }}'

            - service: script.notify_speech
              data:
                media_player: group.google_speakers
                message: '{{ message }}'

        - wait_template: '{{ is_state(trigger.to_state.entity_id, "off") }}'
          timeout:
            minutes: 5
