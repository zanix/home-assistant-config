---
id: notify_door_closed
alias: '[Notify] Door Closed'
description: 'Clears notification when doors are closed'

trigger:
  platform: state
  entity_id: !include ../../templates/doors.yaml
  from: 'on'
  to: 'off'
  for:
    seconds: 30

action:
  - service: script.notify_mobile
    data:
      who: 'parents'
      title: ''
      message: 'clear_notification'
      tag: 'door-{{ trigger.to_state.object_id }}'

  - if:
      - condition: template
        value_template: >-
          {%- set ns = namespace(pass=true) -%}
          {%- set open_doors = states|selectattr('entity_id', 'in', state_attr('group.all_doors','entity_id'))|selectattr('state','eq','on')|map(attribute='entity_id')|list -%}
          {%- for entity_id in open_doors if ns.pass -%}
            {%- set ns.pass = false -%}
          {%- endfor -%}
          {{ ns.pass }}

    then:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.ignore_alert_doors

      - service: script.notify_mobile
        data:
          who: 'parents'
          title: ''
          message: 'clear_notification'
          tag: 'door-alerts-ignored'
