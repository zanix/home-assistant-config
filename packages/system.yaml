###########################################################
# Package: System
###########################################################

homeassistant:
  customize:
    sensor.ha_version:
      icon: mdi:numeric

    sensor.ha_uptime:
      icon: mdi:home-assistant

    sensor.since_last_boot:
      hidden: true

    sensor.disk_use_percent_:
      friendly_name: SD Card use
      icon: mdi:micro-sd

    sensor.external_ip:
      icon: mdi:ethernet

    sensor.cpu_temperature:
      icon: mdi:oil-temperature

    sensor.processor_use:
      icon: mdi:chip

    sensor.memory_use_percent:
      friendly_name: Memory use

    sensor.database_size:
      icon: mdi:database-search

    input_boolean.sql_purge:
      custom_ui_state_card: state-card-tiles
      config:
        columns: 8
        row_height: 50px
        entities:
        - entity: script.sql_purge
          icon: mdi:delete-variant
          column_span: 4
          column: 3

    script.sql_purge:
      hidden: true

    group.battery:
      custom_ui_state_card: state-card-custom-ui
      state_card_mode: badges

    group.all_automations:
      friendly_name: Automations
      control: hidden
      hidden: false

    group.all_scripts:
      friendly_name: Scripts
      control: hidden
      hidden: false

    group.system_status:
      custom_ui_state_card: state-card-custom-ui
    group.system_status_badges:
      custom_ui_state_card: state-card-custom-ui
      state_card_mode: badges

  customize_glob:
    "sensor.table_size_*":
      icon: mdi:database-search

    "sensor.*_battery_level":
      custom_ui_state_card: state-card-custom-ui
      templates:
        theme: "if (state < 30) return 'info_red'; else if (state < 60) return 'info_icon_orange'; else if (state < 80) return 'info_icon_yellow'; else return 'info_icon_green';"

history:
  exclude:
    entities:
      - input_number.sql_purge_keep

recorder:
  exclude:
    entities:
      - input_boolean.sql_purge
      - sensor.date
      - sensor.since_last_boot
      - sensor.time
      - sensor.date__time

influxdb:
  exclude:
    entities:
      - input_number.sql_purge_keep
      - input_boolean.sql_purge
      - sensor.date
      - sensor.since_last_boot
      - sensor.time
      - sensor.date__time

group:
  system_view:
    name: System
    view: yes
    icon: mdi:tune
    entities:
      - group.system_status
      - group.database
      - group.all_automations
      - group.all_scripts
      - group.battery
      - group.zwave

  system_status:
    name: System Status
    control: hidden
    icon: mdi:server-network
    entities:
      - sensor.date
      - sensor.time
      - sensor.hline_1
      - sensor.ha_version
      - sensor.ha_uptime
      - sensor.since_last_boot_templated
      - sensor.hline_2
      - group.system_status_badges
      - sensor.hline_3
      - sensor.external_ip

  system_status_badges:
    name: System Stats
    icon: mdi:chip
    control: hidden
    entities:
      - sensor.cpu_temperature
      - sensor.processor_use
      - sensor.memory_use_percent
      - sensor.disk_use_percent_

  database:
    name: Database Info
    control: hidden
    icon: mdi:database
    entities:
      - sensor.table_size_states
      - sensor.table_size_events
      - sensor.table_size_recorder_runs
      - sensor.table_size_schema_changes
      - sensor.hline_1
      - sensor.database_size
      - sensor.hline_2
      - input_number.sql_purge_keep
      - input_boolean.sql_purge

  battery:
    name: Battery Level
    control: hidden
    icon: mdi:battery-charging
    entities:
      - sensor.door_front_battery_level
      - sensor.door_garage_entry_battery_level
      - sensor.door_garage_outside_battery_level
      - sensor.door_back_battery_level
      - sensor.lock_front_battery_level

sensor:
  - platform: attributes
    friendly_name: Battery
    attribute: battery_level
    unit_of_measurement: "%"
    entities:
      - zwave.lock_front
      - zwave.door_front
      - zwave.door_garage_entry
      - zwave.door_garage_outside
      - zwave.door_back

  - platform: systemmonitor
    resources:
      - type: processor_use
      - type: memory_use_percent
      - type: since_last_boot
      - type: disk_use_percent
        arg: /

  - platform: command_line
    name: HA Version
    command: >-
      cat /config/.HA_VERSION
    scan_interval: 86400

  - platform: command_line
    name: HA Uptime
    command: echo "$(($(date +%s) - $(date -d "$(head -n1 /config/home-assistant.log | cut -d' ' -f-2)" +%s)))"
    scan_interval: 720
    value_template: >-
      {% set uptime = value | int %}
      {% set seconds = (uptime % 60) | int %}
      {% set minutes = ((uptime % 3600) / 60) | int %}
      {% set hours = ((uptime % 86400) / 3600) | int %}
      {% set days = (uptime / 86400) | int %}

      {%- if days > 0 -%}
        {%- if days == 1 -%}
          1 day
        {%- else -%}
          {{ days }} days
        {%- endif -%}
        {{ ', ' }}
      {%- endif -%}
      {%- if hours > 0 -%}
        {{ hours }} h
      {%- endif -%}
      {%- if minutes > 0 -%}
        {%- if hours > 0 -%}
          {{ ', ' }}
        {%- endif -%}
        {{ minutes }} m
      {%- endif -%}
      {%- if seconds > 0 -%}
        {%- if hours > 0 or minutes > 0 -%}
          {{ ', ' }}
        {%- endif -%}
        {{ seconds }} s
      {%- endif -%}

  - platform: command_line
    name: CPU Temperature
    command: "cat /sys/class/thermal/thermal_zone0/temp"
    scan_interval: 720
    unit_of_measurement: 'C'
    value_template: '{{ (value | multiply(0.001)) | round(1) }}'

  - platform: time_date
    display_options:
      - 'date_time'

  - platform: template
    sensors:
      date:
        friendly_name: Date
        icon_template: mdi:calendar
        value_template: '{{ now().strftime("%m/%d/%Y") }}'

      time:
        friendly_name: Time
        icon_template: mdi:clock
        value_template: '{% set timestamp = now().strftime("%I:%M %p") %}{{ timestamp.lstrip("0") }}'

      since_last_boot_templated:
        friendly_name: Pi Uptime
        icon_template: mdi:raspberrypi
        value_template: >-
          {%- set slb = states.sensor.since_last_boot.state.split(' ') -%}
          {%- set count = slb | length -%}
          {%- set hms = slb[count - 1] -%}
          {%- set hms_trimmed = hms.split('.')[0] -%}
          {%- set hms_split = hms_trimmed.split(':') -%}
          {%- set hours = hms_split[0] | int -%}
          {%- set minutes = hms_split[1] | int -%}
          {%- set seconds = hms_split[2] | int -%}

          {%- if count == 3 -%}
            {{ slb[0] ~ ' ' ~ slb[1] ~ ' ' }}
          {%- endif -%}
          {%- if hours > 0 -%}
            {{ hours }} h
          {%- endif -%}
          {%- if minutes > 0 -%}
            {%- if hours > 0 -%}
              {{ ', ' }}
            {%- endif -%}
            {{ minutes }} m
          {%- endif -%}
          {%- if seconds > 0 -%}
            {%- if hours > 0 or minutes > 0 -%}
              {{ ', ' }}
            {%- endif -%}
            {{ seconds }} s
          {%- endif -%}

  - platform: rest
    name: External IP
    scan_interval: 86400
    resource: https://api.ipify.org

  - platform: sql
    db_url: !secret recorder_db_url
    queries:
      - name: "Table size 'states'"
        query: 'SELECT round(((data_length + index_length) / 1024 / 1024), 2) "size" FROM information_schema.TABLES WHERE table_schema = "homeassistant" AND table_name = "states";'
        column: "size"
        unit_of_measurement: "MB"
      - name: "Table size 'schema_changes'"
        query: 'SELECT round(((data_length + index_length) / 1024 / 1024), 2) "size" FROM information_schema.TABLES WHERE table_schema = "homeassistant" AND table_name = "schema_changes";'
        column: "size"
        unit_of_measurement: "MB"
      - name: "Table size 'recorder_runs'"
        query: 'SELECT round(((data_length + index_length) / 1024 / 1024), 2) "size" FROM information_schema.TABLES WHERE table_schema = "homeassistant" AND table_name = "recorder_runs";'
        column: "size"
        unit_of_measurement: "MB"
      - name: "Table size 'events'"
        query: 'SELECT round(((data_length + index_length) / 1024 / 1024), 2) "size" FROM information_schema.TABLES WHERE table_schema = "homeassistant" AND table_name = "events";'
        column: "size"
        unit_of_measurement: "MB"
      - name: "Database size"
        query: 'SELECT round(sum(data_length + index_length) / 1024 / 1024, 2) "size" FROM information_schema.tables WHERE table_schema = "homeassistant" GROUP BY table_schema;'
        column: "size"
        unit_of_measurement: "MB"

shell_command:
  zwave_disco_off: echo -e -n "\x01\x08\x00\xF2\x51\x01\x00\x05\x01\x51" > /dev/ttyACM0
  zwave_disco_on: echo -e -n "\x01\x08\x00\xF2\x51\x01\x01\x05\x01\x50" > /dev/ttyACM0

input_boolean:
  sql_purge:

input_number:
  sql_purge_keep:
    name: Days to Keep
    icon: mdi:calendar-today
    initial: 7
    min: 1
    max: 60

script:
  sql_purge:
    alias: "Purge Home Assistant Database"
    sequence:
      - service: recorder.purge
        data_template: 
          keep_days : >
            {{ states.input_number.sql_purge_keep.state | int }}

automation:
  - alias: "[System] Clear TTS Cache"
    trigger:
      - platform: time
        at: "00:00:00"
    condition:
      - condition: time
        weekday:
          - mon
    action:
      - service: tts.clear_cache

  - alias: "[System] Failed Login"
    trigger:
      - platform: template
        value_template: "{{ states('persistent_notification.httplogin') != 'unknown' }}"
    action:
      - service: notify.join_user1
        data_template:
          title: "{{ state_attr('persistent_notification.httplogin', 'title') }}"
          message: "{{ state_attr('persistent_notification.httplogin', 'message') }}"
          data:
            icon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/home-assistant.png"
            smallicon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/home-assistant.png"

  - alias: "[System] Low Battery"
    trigger:
      - platform: time
        at: "10:00:00"
      - platform: time
        at: "18:00:00"
    condition:
      - condition: template
        value_template: >
          {%- set threshold_high = 30 -%}
          {%- set threshold_low = 0 -%}
          {% macro battery_level() %}
          {% set domains = ['light', 'switch', 'sensor', 'zwave', 'lock'] %}
          {% for domain in domains -%}
          {% for item in states[domain] if ((item.attributes.battery_level is defined and item.attributes['battery_level'] | int < threshold_high and item.attributes['battery_level'] | int > threshold_low) or ('battery' in item.name | lower and ((item.state | int < threshold_high and item.state | int > threshold_low and item.state|int != 0) or item.state | lower == 'low' or item.state | lower == 'unknown'))) -%}
          {% if (item.attributes.battery_level is defined and item.attributes['battery_level'] | int < threshold_high and item.attributes['battery_level'] | int > threshold_low) -%}
          {{ item.name }}{% endif -%}
          {% if 'battery' in item.name | lower and ((item.state | int < threshold_high and item.state | int > threshold_low and item.state|int != 0) or item.state | lower == 'low' or item.state | lower == 'unknown') -%}
          {{ item.name }}{% endif -%}
          {% endfor %}
          {%- endfor %}
          {% endmacro %}
          {{ battery_level() |trim != '' }}
    action:
      - service: persistent_notification.create
        data_template:
          title: "Low Battery Levels"
          notification_id: low-battery-alert
          message: >
            {%- set threshold_high = 30 -%}
            {%- set threshold_low = 0 -%}
            {% macro battery_level(domain) %}
            {%- for item in states[domain] if ((item.attributes.battery_level is defined and item.attributes['battery_level'] | int < threshold_high and item.attributes['battery_level'] | int > threshold_low) or ('battery' in item.name | lower and ((item.state | int < threshold_high and item.state|int != 0) or item.state | lower == 'low' or item.state | lower == 'unknown'))) -%}
            {% if (item.attributes.battery_level is defined and item.attributes['battery_level'] | int < threshold_high and item.attributes['battery_level'] | int > threshold_low) -%}
            {{ item.attributes.friendly_name }} ({{ item.attributes['battery_level'] }}){%- if not loop.last %}, {% endif -%}{%- endif -%}
            {%- if 'battery' in item.name | lower and ((item.state | int < threshold_high and item.state | int > threshold_low and item.state|int != 0) or item.state | lower == 'low' or item.state | lower == 'unknown') -%}
            {{ item.attributes.friendly_name }} ({{ item.state }}){% if not loop.last %}, {% endif %}{% endif -%}
            {%- endfor -%}
            {% endmacro %}
            {%- set domains = ['light', 'switch', 'sensor', 'zwave', 'lock'] -%}
            {%- for domain in domains if battery_level(domain) |trim != ''-%}
            {{ battery_level(domain) }}{%- if not loop.last %}, {% endif -%}
            {%- endfor -%}
      - service: notify.join_user1
        data_template:
          title: "Low Battery Levels"
          message: >
            {%- set threshold_high = 30 -%}
            {%- set threshold_low = 0 -%}
            {% macro battery_level(domain) %}
            {%- for item in states[domain] if ((item.attributes.battery_level is defined and item.attributes['battery_level'] | int < threshold_high and item.attributes['battery_level'] | int > threshold_low) or ('battery' in item.name | lower and ((item.state | int < threshold_high and item.state|int != 0) or item.state | lower == 'low' or item.state | lower == 'unknown'))) -%}
            {% if (item.attributes.battery_level is defined and item.attributes['battery_level'] | int < threshold_high and item.attributes['battery_level'] | int > threshold_low) -%}
            {{ item.attributes.friendly_name }} ({{ item.attributes['battery_level'] }}){%- if not loop.last %}, {% endif -%}{%- endif -%}
            {%- if 'battery' in item.name | lower and ((item.state | int < threshold_high and item.state | int > threshold_low and item.state|int != 0) or item.state | lower == 'low' or item.state | lower == 'unknown') -%}
            {{ item.attributes.friendly_name }} ({{ item.state }}){% if not loop.last %}, {% endif %}{% endif -%}
            {%- endfor -%}
            {% endmacro %}
            {%- set domains = ['light', 'switch', 'sensor', 'zwave', 'lock'] -%}
            {%- for domain in domains if battery_level(domain) |trim != ''-%}
            {{ battery_level(domain) }}{%- if not loop.last %}, {% endif -%}
            {%- endfor -%}
          data:
            icon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/battery-alert.png"
            smallicon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/home-assistant.png"

  - alias: "[System] SD Card Space at 90%"
    trigger:
      - platform: numeric_state
        entity_id: sensor.disk_use_percent_
        above: 89
    action:
      - service: persistent_notification.create
        data:
          title: Low SD Card Space
          message: "SD card usage is at {{ states.sensor.disk_use_percent_.state }}%"
          notification_id: low_disk_space
      - service: notify.join_user1
        data_template:
          title: Low SD Card Space
          message: "SD card usage is at {{ states.sensor.disk_use_percent_.state }}%"
          data:
            icon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/micro-sd.png"
            smallicon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/home-assistant.png"

  - alias: "[System] Set Theme at Startup"
    trigger:
      - platform: homeassistant
        event: start
    action:
      service: frontend.set_theme
      data:
        name: PmxMononight

  - alias: "[System] Update Available"
    hide_entity: true
    trigger:
      - platform: state
        entity_id: updater.updater
    condition:
      - condition: template
        value_template: "{{ states('updater.updater') != 'unknown' }}"
    action:
      - service: persistent_notification.create
        data:
          title: Update Available
          message: "Home Assistant {{ states('updater.updater') }} is available. You are currently running {{ states('sensor.ha_version') }}. [Release Notes]({{ state_attr('updater.updater', 'release_notes') }})"
          notification_id: update_available
      - service: notify.join_user1
        data_template:
          title: Update Available
          message: "Home Assistant {{ states('updater.updater') }} is available. You are currently running {{ states('sensor.ha_version') }}"
          data:
            icon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/update.png"
            smallicon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/home-assistant.png"
            url: "{{ state_attr('updater.updater', 'release_notes') }}"

  - alias: "[System] Z-Wave Heal"
    trigger:
      - platform: time
        at: "02:30:00"
    action:
      - service: zwave.heal_network
