---
# The open source modular smart mirror platform.
# This is a bunch of rest sensors and switches to interact with the
# Remote Contol module for MagicMirror
#
# https://magicmirror.builders
# https://github.com/Jopyth/MMM-Remote-Control
#
sensor:
  - platform: rest
    name: "Smart Display Brightness"
    resource: !secret smart_display_api_brightness
    value_template: '{{ value_json.result }}'

switch:
  - platform: rest
    name: "Smart Display Monitor"
    resource: !secret smart_display_api_monitor
    body_on: '{"monitor": "on"}'
    body_off: '{"monitor": "off"}'
    is_on_template: '{{ value_json.monitor == "on" }}'
    headers:
      Content-Type: application/json

rest_command:
  smart_display_brightness:
    url: !secret smart_display_api_brightness
    method: POST
    payload: '{"brightness": {{ brightness }}}'
    content_type: "application/json; charset=utf-8"

light:
  - platform: template
    lights:
      smart_display:
        friendly_name: "Smart Display"
        value_template: "{{ states('switch.smart_display_monitor') }}"
        icon_template: >-
          {% if is_state('switch.smart_display_monitor', 'on') %}
            mdi:monitor
          {% else %}
            mdi:monitor-off
          {% endif %}
        turn_on:
          service: switch.turn_on
          target:
            entity_id: switch.smart_display_monitor
        turn_off:
          service: switch.turn_off
          target:
            entity_id: switch.smart_display_monitor
        set_level:
          service: rest_command.smart_display_brightness
          data:
            brightness: "{{ (brightness * 100 / 255) | int }}"
        level_template: >-
          {%- if is_state('switch.smart_display_monitor', 'on') -%}
            {{ (states('sensor.smart_display_brightness') | float(default=0) * 2.55) | round() }}
          {%- else -%}
            0
          {%- endif -%}

automation:
  - id: smart_display_bright_when_kitchen_light_on
    alias: "ðŸ“± Smart Display Brighten when Kitchen Light On"
    trigger:
      - platform: state
        entity_id: light.kitchen
        from: "off"
        to: "on"
      - platform: state
        entity_id: switch.dining_room_light
        from: "off"
        to: "on"
      - platform: numeric_state
        entity_id: light.kitchen
        attribute: brightness
        above: 45
    condition:
      - condition: state
        entity_id: group.people
        state: home
      - or:
          - condition: state
            entity_id: switch.dining_room_light
            state: "on"
          - and:
              - condition: state
                entity_id: light.kitchen
                state: "on"
              - condition: numeric_state
                entity_id: light.kitchen
                attribute: brightness
                above: 45
      - condition: sun
        after: sunset
      - condition: time
        before: input_datetime.smart_display_off
    action:
      - service: rest_command.smart_display_brightness
        data:
          brightness: 100

  - id: smart_display_dim_when_kitchen_light_off
    alias: "ðŸ“± Smart Display Dim when Kitchen Light Off"
    trigger:
      - platform: state
        entity_id: light.kitchen
        from: "on"
        to: "off"
      - platform: state
        entity_id: switch.dining_room_light
        from: "on"
        to: "off"
      - platform: numeric_state
        entity_id: light.kitchen
        attribute: brightness
        below: 45
    condition:
      - condition: state
        entity_id: group.people
        state: home
      - condition: state
        entity_id: switch.dining_room_light
        state: "off"
      - or:
          - condition: state
            entity_id: light.kitchen
            state: "off"
          - condition: numeric_state
            entity_id: light.kitchen
            attribute: brightness
            below: 45
      - condition: sun
        after: sunset
      - condition: time
        before: input_datetime.smart_display_off
    action:
      - service: rest_command.smart_display_brightness
        data:
          brightness: 40

  - id: smart_display_dim_at_sunset
    alias: "ðŸ“± Smart Display Dim at Sunset"
    trigger:
      platform: sun
      event: sunset
    condition:
      - condition: state
        entity_id: group.people
        state: home
      - condition: state
        entity_id: switch.dining_room_light
        state: "off"
      - or:
          - condition: state
            entity_id: light.kitchen
            state: "off"
          - condition: numeric_state
            entity_id: light.kitchen
            attribute: brightness
            below: 45
      - condition: time
        before: input_datetime.smart_display_off
    action:
      - service: rest_command.smart_display_brightness
        data:
          brightness: 40

  - id: smart_display_on_when_arrive
    alias: "ðŸ“± Smart Display On when Arrive"
    trigger:
      platform: state
      entity_id: group.people
      from: "not_home"
      to: "home"
    condition:
      - condition: time
        after: input_datetime.smart_display_on
      - condition: time
        before: input_datetime.smart_display_off
    action:
      - service: homeassistant.turn_on
        data:
          entity_id: switch.smart_display_monitor

  - id: smart_display_off_when_away
    alias: "ðŸ“± Smart Display Off when Away"
    trigger:
      platform: state
      entity_id: group.people
      from: "home"
      to: "not_home"
      for:
        minutes: 10
    condition:
      - condition: time
        after: input_datetime.smart_display_on
      - condition: time
        before: input_datetime.smart_display_off
    action:
      - service: homeassistant.turn_off
        data:
          entity_id: switch.smart_display_monitor

  - id: smart_display_off_at_night
    alias: "ðŸ“± Smart Display Off at Night"
    condition:
      - condition: state
        entity_id: group.people
        state: home
    trigger:
      platform: time
      at: input_datetime.smart_display_off
    action:
      - service: homeassistant.turn_off
        data:
          entity_id: switch.smart_display_monitor

  - id: smart_display_on_at_morning
    alias: "ðŸ“± Smart Display On at Morning"
    condition:
      - condition: state
        entity_id: group.people
        state: home
    trigger:
      platform: time
      at: input_datetime.smart_display_on
    action:
      - service: homeassistant.turn_on
        data:
          entity_id: switch.smart_display_monitor
      - service: rest_command.smart_display_brightness
        data:
          brightness: 100
