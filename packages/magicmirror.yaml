---
# The open source modular smart mirror platform.
# This is a bunch of rest sensors and switches to interact with the
# Remote Contol module for MagicMirror
#
# https://magicmirror.builders
# https://github.com/Jopyth/MMM-Remote-Control
# https://www.home-assistant.io/integrations/light.mqtt#default-schema
# https://www.home-assistant.io/integrations/button.mqtt/
# https://www.home-assistant.io/integrations/binary_sensor.mqtt/
#
mqtt:
  binary_sensor:
    - name: MagicMirror Connected
      unique_id: magicmirror_connected
      state_topic: 'lnxlink/magicmirror/lwt'
      value_template: '{{ value }}'
      payload_on: 'ON'
      payload_off: 'OFF'
      device_class: connectivity
      qos: 0

  light:
    - name: MagicMirror Monitor
      unique_id: magicmirror_monitor
      icon: mdi:monitor

      availability_topic: "magicmirror/diningroom/availability"

      state_topic: "magicmirror/diningroom/monitor/state"
      payload_on: "ON"
      payload_off: "OFF"
      command_topic: "magicmirror/diningroom/monitor/set"
      on_command_type: first

      brightness_state_topic: "magicmirror/diningroom/monitor/brightness"
      brightness_command_topic: "magicmirror/diningroom/monitor/brightness/set"
      brightness_command_template: '{ "action": "BRIGHTNESS", "value": "{{ value }}" }'
      brightness_scale: 200

      color_mode_value_template: "color_temp"
      color_temp_state_topic: "magicmirror/diningroom/monitor/temp"
      color_temp_command_topic: "magicmirror/diningroom/monitor/temp/set"
      color_temp_command_template: '{ "action": "TEMP", "value": "{{ value }}" }'

  button:
    - name: MagicMirror Refresh
      availability_topic: "magicmirror/diningroom/availability"
      command_topic: "magicmirror/diningroom/system"
      payload_press: "REFRESH"

automation:
  - id: magicmirror_on_off_schedule
    alias: ðŸ“± MagicMirror On/Off Schedule
    mode: single
    triggers:
      - entity_id: schedule.magicmirror
        id: "on"
        to: "on"
        trigger: state
      - entity_id: schedule.magicmirror
        id: "off"
        to: "off"
        trigger: state
      - trigger: state
        entity_id:
          - binary_sensor.bed_presence_f56148_bed_occupied_both
        to: "on"
        id: "off"
        for:
          hours: 0
          minutes: 5
          seconds: 0
      - trigger: state
        entity_id:
          - binary_sensor.bed_presence_f56148_bed_occupied_both
        to: "off"
        id: "on"
        for:
          hours: 0
          minutes: 5
          seconds: 0
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id: "on"
              - condition: state
                entity_id: group.people
                state: home
            sequence:
              - action: light.turn_on
                data:
                  brightness_pct: 50
                target:
                  entity_id: light.magicmirror_monitor
          - conditions:
              - condition: trigger
                id: "off"
            sequence:
              - action: light.turn_off
                target:
                  entity_id: light.magicmirror_monitor
                data: {}

  - id: magicmirror_brightness_on_lights_on_off
    alias: ðŸ“± MagicMirror Brightness on Lights On/Off
    mode: restart
    triggers:
      - entity_id: light.kitchen
        trigger: state
      - entity_id: light.dining_room
        trigger: state
      - entity_id: light.dining_room
        attribute: brightness
        above: 45
        trigger: numeric_state
      - entity_id: light.dining_room
        attribute: brightness
        below: 45
        trigger: numeric_state
    conditions:
      - condition: state
        entity_id: group.people
        state: home
      - condition: state
        entity_id: schedule.magicmirror
        state: "on"
      - condition: sun
        after: sunset
    actions:
      - choose:
          - conditions:
              - condition: or
                conditions:
                  - condition: state
                    entity_id: light.kitchen
                    state: "on"
                  - condition: state
                    entity_id: light.dining_room
                    state: "on"
                  - condition: numeric_state
                    entity_id: light.dining_room
                    attribute: brightness
                    above: 45
            sequence:
              - action: light.turn_on
                data:
                  brightness_pct: 50
                target:
                  entity_id: light.magicmirror_monitor
          - conditions:
              - condition: state
                entity_id: light.kitchen
                state: "off"
              - or:
                  - condition: state
                    entity_id: light.dining_room
                    state: "off"
                  - condition: numeric_state
                    entity_id: light.dining_room
                    attribute: brightness
                    below: 45
            sequence:
              - action: light.turn_on
                data:
                  brightness_pct: 20
                target:
                  entity_id: light.magicmirror_monitor

  - id: magicmirror_dim_at_sunset
    alias: ðŸ“± MagicMirror Dim at Sunset
    mode: single
    triggers:
      - event: sunset
        trigger: sun
    conditions:
      - condition: state
        entity_id: group.people
        state: home
      - condition: state
        entity_id: light.kitchen
        state: "off"
      - or:
          - condition: state
            entity_id: light.dining_room
            state: "off"
          - condition: numeric_state
            entity_id: light.dining_room
            attribute: brightness
            below: 45
      - condition: state
        entity_id: schedule.magicmirror
        state: "on"
    actions:
      - action: light.turn_on
        target:
          entity_id: light.magicmirror_monitor
        data:
          brightness_pct: 20

  - id: magicmirror_on_off_presence
    alias: ðŸ“± MagicMirror On/Off Presence
    mode: single
    triggers:
      - entity_id: group.people
        id: away
        to: not_home
        from: home
        for:
          hours: 0
          minutes: 5
          seconds: 0
        trigger: state
      - entity_id: group.people
        id: home
        from: not_home
        to: home
        trigger: state
    conditions:
      - condition: state
        entity_id: schedule.magicmirror
        state: "on"
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id: home
            sequence:
              - action: light.turn_on
                target:
                  entity_id: light.magicmirror_monitor
                data: {}
          - conditions:
              - condition: trigger
                id: away
            sequence:
              - action: light.turn_off
                target:
                  entity_id: light.magicmirror_monitor
                data: {}
