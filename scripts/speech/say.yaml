---
say:
  alias: 'Say'
  description: 'Text-to-speech.'
  icon: mdi:microphone-message
  mode: parallel

  fields:
    media_player:
      name: 'Media Player'
      example: media_player.living_room_speaker
      required: true
      selector:
        entity:
          domain: media_player
    message:
      name: 'Message'
      example: 'Message text'
      required: true
      selector:
        text:
          multiline: true

  variables:
    mqtt_message_state: '{{ message|striptags }}'
    mqtt_message_attributes: |-
      {
        "target": '{{ media_player }}',
        "timestamp": '{{ now()|as_local }}'
      }

  sequence:
    - parallel:
        - service: script.say_cloud
          data:
            media_player: '{{ media_player }}'
            message: '{{ message }}'

        - service: script.toast
          data:
            message: '{{ mqtt_message_state }}'
            duration: 30000

        # Store Last Message
        - service: script.store_mqtt_sensor
          data:
            name: 'last_message'
            state: '{{ mqtt_message_state }}'
            # attributes: '{{ mqtt_message_attributes }}'

        # Store Last Speaker
        - service: script.store_mqtt_sensor
          data:
            name: 'last_speaker'
            state: '{{ media_player }}'
