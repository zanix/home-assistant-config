---
notify_mobile_ios:
  alias: '[Notify] Mobile (iOS)'
  description: 'Notify users via mobile devices'
  icon: mdi:cellphone-message
  mode: parallel

  fields:
    who:
      description: 'Which person to send to [ josh | amy | parents | kids | family ]'
      example: 'josh'
      selector:
        text:
    title:
      description: 'Title of the notification'
      example: 'Startup: Home Assistant is Up and Running!'
      selector:
        text:
    subtitle:
      description: 'Subtitle of the notification'
      example: 'Subject for long text'
      selector:
        text:
    message:
      description: 'Message of the notification'
      example: 'Message text'
      selector:
        text:
    icon:
      description: 'Icon to use'
      example: '/local/image.png'
      selector:
        text:
    image:
      description: 'Image to attach'
      example: '/local/image.png'
      selector:
        text:
    sound:
      description: 'Publicly available URL for a sound to play with the notification'
      example: 'local/sound.mp3'
      selector:
        text:
    notification_sound:
      description: 'Sound for the notification'
      example: 'Stockholm_Haptic.caf'
      selector:
        text:
    camera:
      description: 'Camera stream to attach'
      example: 'camera.doorbell'
      selector:
        entity:
          domain: camera
    url:
      description: 'Action when clicking the notification'
      example: 'lovelace/main'
      selector:
        text:
    group:
      description: 'Message group'
      example: 'Home Assistant'
      selector:
        text:
    tag:
      description: 'Unique tag for the notification'
      example: 'tag'
      selector:
        text:
    actions:
      description: 'A list of actions for actionable notifications'
      example: ''
      selector:
        action:

  # Set local variables for reuse in this script.
  variables:
    notification_service: 'notify.{{ who|default("josh", true) }}'
    group_id: '{{ group|default("Home Assistant") }}'
    sound_path: |
      {%- if sound is string -%}
        {%- if sound.startswith("http") -%}
          {{ sound }}
        {%- else -%}
          {{ states.sensor.base_url.state }}/{{ sound }}
        {%- endif -%}
      {%- endif -%}
    # Every notification should have a sound. Actionable notifications should grab your attention.
    sound_file: |
      {%- if notification_sound is string %}
        {{ notification_sound }}
      {%- else %}
        Stockholm_Haptic.caf
      {%- endif %}

  sequence:
    - if:
        - condition: state
          entity_id: input_boolean.mobile_notifications
          state: 'on'

      then:
        - choose:
            # Send camera stream.
            - conditions: '{{ camera is string }}'
              sequence:
                - service: '{{ notification_service }}'
                  data:
                    title: '{{ title }}'
                    message: '{{ message }}'
                    data:
                      subtitle: '{{ subtitle|default(none, true) }}'
                      entity_id: '{{ camera }}'
                      url: '{{ url|default("lovelace/main", true) }}'
                      audio: '{{ sound_path|default(none, true) }}'
                      group: '{{ group_id }}'
                      tag: '{{ tag|default(none, true) }}'
                      actions: '{{ actions|default(none, true) }}'
                      push:
                        sound: '{{ sound_file }}'

            # Send an image.
            - conditions: '{{ image is string }}'
              sequence:
                - service: '{{ notification_service }}'
                  data:
                    title: '{{ title }}'
                    message: '{{ message }}'
                    data:
                      subtitle: '{{ subtitle|default(none, true) }}'
                      image: '{{ image }}'
                      url: '{{ url|default("lovelace/main", true) }}'
                      audio: '{{ sound_path|default(none, true) }}'
                      group: '{{ group_id }}'
                      tag: '{{ tag|default(none, true) }}'
                      actions: '{{ actions|default(none, true) }}'
                      push:
                        sound: '{{ sound_file }}'

          # Send a basic, link, or actionable notification message.
          default:
            - service: '{{ notification_service }}'
              data:
                title: '{{ title }}'
                message: '{{ message }}'
                data:
                  subtitle: '{{ subtitle|default(none, true) }}'
                  image: '{{ icon|default("/local/icons/home-assistant.png") }}'
                  url: '{{ url|default("lovelace/main", true) }}'
                  audio: '{{ sound_path|default(none, true) }}'
                  group: '{{ group_id }}'
                  tag: '{{ tag|default(none, true) }}'
                  actions: '{{ actions|default(none, true) }}'
                  push:
                    sound: '{{ sound_file }}'
