---
notify_join:
  alias: '[Notify] Join'
  description: 'Notify Join devices.'
  icon: mdi:content-copy
  mode: parallel

  fields:
    who:
      name: 'Who'
      description: 'Which device to send to [ shield_living_room, shield_family_room, shield_master_bedroom, shield_all ]'
      example: 'shield_all'
      required: true
    title:
      name: 'Title'
      example: 'Startup: Home Assistant is Up and Running!'
      selector:
        text:
    message:
      name: 'Message'
      example: 'Message text'
      selector:
        text:
          multiline: true
    icon:
      name: 'Icon'
      description: 'Notification icon. If this image has transparency, it will also be used as the status bar icon if small icon is not set.'
      example: 'local/icon.png'
      selector:
        text:
    smallicon:
      name: 'Small icon'
      description: 'Notification status bar icon.'
      default: 'local/icons/home-assistant.png'
      example: 'local/icons/home-assistant.png'
      selector:
        text:
    image:
      name: 'Image'
      description: 'Publicly available URL for an image to show up in the notification.'
      example: 'local/image.png'
      selector:
        text:
    sound:
      name: 'Sound'
      description: 'Publicly available URL for a sound to play with the notification.'
      example: 'local/sound.mp3'
      selector:
        text:
    url:
      name: 'URL'
      description: 'Action when clicking the notification.'
      example: 'lovelace/main'
      selector:
        text:
    group:
      name: 'Message group'
      default: 'Home Assistant'
      example: 'Home Assistant'
      selector:
        text:
    tag:
      name: 'Tag'
      description: 'Unique tag for the notification.'
      example: 'tag'
      selector:
        text:
    actions:
      name: 'Actions'
      description: 'A list of actions for Join notification buttons.'
      example: ''
      selector:
        action:

  # Set local variables for reuse in this script.
  variables:
    notification_service: 'notify.{{ who }}'
    image_path: >-
      {%- if image is string -%}
        {%- if image.startswith("http") -%}
          {{ image }}
        {%- else -%}
          {{ states("sensor.base_url") }}/{{ image }}
        {%- endif -%}
      {%- endif -%}
    icon_path: >-
      {%- if icon is string -%}
        {%- if icon.startswith("http") -%}
          {{ icon }}
        {%- else -%}
          {{ states("sensor.base_url") }}/{{ icon }}
        {%- endif -%}
      {%- endif -%}
    smallicon_path: >-
      {%- if smallicon is string -%}
        {%- if smallicon.startswith("http") -%}
          {{ smallicon }}
        {%- else -%}
          {{ states("sensor.base_url") }}/{{ smallicon }}
        {%- endif -%}
      {%- endif -%}
    sound_path: >-
      {%- if sound is string -%}
        {%- if sound.startswith("http") -%}
          {{ sound }}
        {%- else -%}
          {{ states("sensor.base_url") }}/{{ sound }}
        {%- endif -%}
      {%- endif -%}
    group_id: '{{ group|default("Home Assistant") }}'

  sequence:
    # Only send if enabled.
    # - condition: state
    #   entity_id: input_boolean.mobile_notifications
    #   state: 'on'

    - if:
        - condition: template
          value_template: '{{ message not in ["clear_notification", "remove_channel", "TTS"] }}'

      then:
        - service: '{{ notification_service }}'
          data:
            title: '{{ title }}'
            message: '{{ message }}'
            data:
              icon: '{{ icon_path|default(none, true) }}'
              smallicon: '{{ smallicon_path|default(states("sensor.base_url") ~ "/local/icons/home-assistant.png", true) }}'
              image: '{{ image_path|default(none, true) }}'
              sound: '{{ sound_path|default(none, true) }}'
              url: '{{ url|default(none, true) }}'
              category: '{{ group_id }}'
              notification_id: '{{ tag|default(none, true) }}'
              actions: '{{ actions|default(none, true) }}'
