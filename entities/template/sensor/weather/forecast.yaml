---
# The template integration allows creating entities which derive their values
# from other data. This is done by specifying templates for properties of an
# entity, like the name or the state.
#
# https://www.home-assistant.io/integrations/template/
#
sensor:
  - name: Forecast
    availability: "{{ not states('weather.openweathermap') in ['unknown', 'unavailable'] }}"
    state: >-
      {% if not states('weather.openweathermap') in ['unknown', 'unavailable'] %}
        {% set hour = now().hour | int %}
        {% if hour < 17 %}
          Today's forecast is {{ state_attr('weather.openweathermap', 'forecast')[0]['condition'] | replace('clear', 'clear ') | replace('partly', 'partly ') }},
          with a high of {{ state_attr('weather.openweathermap', 'forecast')[0]['temperature'] | round }} degrees.
        {% else %}
          {%- set condition = state_attr('weather.openweathermap', 'forecast')[1]['condition'] | replace('clear', 'clear ') | replace('partly', 'partly ') -%}
          {%- set high = state_attr('weather.openweathermap', 'forecast')[1]['temperature'] | round -%}
          {%- set low = state_attr('weather.openweathermap', 'forecast')[1]['templow'] | round -%}
          {%- set chance = state_attr('weather.openweathermap', 'forecast')[1]['precipitation_probability'] -%}
          Tomorrow's forecast is {{ condition }},
          {% if chance > 0 -%}a {{ chance }} percent chance of precipitation,{% endif %}
          with a high of {{ high }} degrees, and a low of {{ low }} degrees.
        {% endif %}
      {% endif %}
