---
# The template integration allows creating entities which derive their values
# from other data. This is done by specifying templates for properties of an
# entity, like the name or the state.
#
# https://www.home-assistant.io/integrations/template/
#
sensor:
  - name: Low Battery Devices
    icon: 'mdi:battery-{{ iif(this.state | int(default=0) == 0, "check", "alert") }}'
    state: '{{ this.attributes.get("entity_id", []) | count }}'
    attributes:
      excluded_entities: >-
        {{[
          'sensor.galaxy_s21_battery_level',
          'sensor.pixel_7_battery_level',
          'sensor.ipad_josh_battery_level',
          'sensor.quest_battery_level',
          'sensor.load_percentage',
          'sensor.battery_state_of_charge'
        ]}}
      entity_id: >-
        {% set threshold = 30 %}
        {% set result = namespace(devices=[]) %}
        {% set devices = states.sensor
          | reject('in', ['unknown', 'unavailable', 'undefined'])
          | rejectattr('state', 'in', ['unknown', 'unavailable', 'undefined'])
          | rejectattr('entity_id', 'in', this.attributes.get('excluded_entities', []))
          | rejectattr('attributes.device_class', 'undefined')
          | selectattr('attributes.device_class', '==', 'battery')
          | list
        %}
        {% for device in devices %}
          {% if device.state | int(-1) <= threshold %}
            {% set result.devices = result.devices + [device.entity_id] %}
          {% endif %}
        {% endfor %}
        {{ result.devices }}
